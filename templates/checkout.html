<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="static/js/check_main.js"></script>
    <script>
        var user = '{{request.user}}'
        var total = '{{order.get_cart_total}}'
        console.log(user)
        console.log(total)
    </script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <title>Checkout</title>
    <link rel="icon" href="static/img/lologo.png" type="image/icon type">
    <script src="https://js.stripe.com/v3/"></script>
    <style type="text/css">
		/**
		 * The CSS shown here will not be introduced in the Quickstart guide, but shows
		 * how you can use CSS to style your Element's container.
		 */
		.StripeElement {
		  box-sizing: border-box;

		  height: 40px;

		  padding: 10px 12px;

		  border: 1px solid transparent;
		  border-radius: 4px;
		  background-color: white;

		  box-shadow: 0 1px 3px 0 #e6ebf1;
		  -webkit-transition: box-shadow 150ms ease;
		  transition: box-shadow 150ms ease;
		}

		.StripeElement--focus {
		  box-shadow: 0 1px 3px 0 #cfd7df;
		}

		.StripeElement--invalid {
		  border-color: #fa755a;
		}

		.StripeElement--webkit-autofill {
		  background-color: #fefde5 !important;
		}
	</style>
</head>

<body>
    <div class="container">
        <div class="py-5 text-center">
            <img class="d-block mx-auto mb-4" src="static/img/lologo.png" alt="" width="72" height="72">
            <h2><STRONG>C H E C K O U T</STRONG></h2>
            <p class="lead">Delivery time and custom charges vary from country to country. <br>Orders within India will
                be delivered in 1-3 weeks of time. Orders outside India will be
                shipped in a week. <br><strong>Please note that we don't cover the custom charges of deliveries outside
                    India. </strong></p>
        </div>
        <div class="row">
            <div class="col-md-4 order-md-2 mb-4">
                <h4 class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Your cart</span>
                    <span class="badge badge-secondary badge-pill">3</span>
                </h4>
                <ul class="list-group mb-3 sticky-top">
                    {% for item in items %}
                    <li class="list-group-item d-flex justify-content-between lh-condensed">
                        <div>
                            <h6 class="my-0">{{item.product.name}} ({{item.quantity}})</h6>
                        </div>
                        <span class="text-muted">₹{{item.product.price}}</span>
                    </li>
                    {% endfor %}
                    <li class="list-group-item d-flex justify-content-between bg-light">

                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Total (INR)</span>
                        <strong>₹{{order.get_cart_total|floatformat:2}}</strong>
                    </li>
                </ul>
            </div>
            <div class="col-md-8 order-md-1">
                <h4 class="mb-3">Shipping address</h4>

                <form class="needs-validation" id="payment-form" novalidate="" method="POST" action={% url 'process_order' %}>
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName">First name</label>
                            {% if request.user.is_authenticated %}
                            <input type="text" class="form-control" name="name" id="firstName"
                                {% if request.user.first_name %} 
                                    value = {{request.user.first_name}}
                                {% else %}
                                    value = ""
                                {% endif %}
                            required="">
                            {% else %}
                                <input type="text" class="form-control" name="name" id="firstName" placeholder="first name" required="">
                            {% endif %}
                            <div class="invalid-feedback"> Valid first name is required. </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName">Last name</label>
                            {% if request.user.is_authenticated %}
                                <input type="text" class="form-control" id="lastName" {% if request.user.first_name %} 
                                    value = {{request.user.last_name}}
                                {% else %}
                                    value = ""
                                {% endif %}
                            required="">
                            {% else %}
                                <input type="text" class="form-control" id="lastName" placeholder="last name" required="">
                            {% endif %}
                            <div class="invalid-feedback"> Valid last name is required. </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="username">Username</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">@</span>
                            </div>
                            {% if request.user.is_authenticated %}
                            <input type="text" class="form-control" name="username" id="username" value={{request.user}}
                                required="">
                            {% else %}
                            <input type="text" class="form-control" name="username" id="username" placeholder="username"
                                required="">
                            {% endif %}
                            <div class="invalid-feedback" style="width: 100%;"> Your username is required. </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="username">Email</label>
                        <div class="input-group">
                            {% if request.user.is_authenticated %}
                            <input type="text" class="form-control" name="email" id="email" value={{request.user.email}}
                                required="">
                            {% else %}
                            <input type="text" class="form-control" name="email" id="email" placeholder="email"
                                required="">
                            {% endif %}
                            <div class="invalid-feedback" style="width: 100%;"> Your email is required. </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" id="address" name="address"
                            placeholder="Please enter your full address" required="">
                        <div class="invalid-feedback"> Please enter your shipping address. </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label for="city">city</label>
                            <input type="text" class="form-control" name="city" id="city" placeholder=""
                                required="">
                            <div class="invalid-feedback"> Please select a valid city. </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="state">State</label>
                            <input type="text" class="form-control" name="state" id="state" placeholder=""
                                required="">
                            <div class="invalid-feedback"> Please enter your shipping address. </div>
                            <div class="invalid-feedback"> Please provide a valid state. </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="zip">Zip</label>
                            <input type="text" class="form-control" id="zip" name="zipcode" placeholder="" required="">
                            <div class="invalid-feedback"> Zip code required. </div>
                        </div>
                    </div>
                    <div class="form-field-12">
						<label for="amount">Choose Amount:</label>
						<br>
						<br>
						<select required name="amount" id="amount">
						  <option selected value="5">$5 --- Here's a coffee, on me :)</option>
						  <option value="10">$10 --- You helped me, so I am going to help you</option>
						  <option value="25">$25 --- I love your channel!</option>
						</select>
					</div>
                    <div class="form-row">
				    <label for="card-element">
				      Credit or debit card
				    </label>
				    <div id="card-element">
				      <!-- A Stripe Element will be inserted here. -->
				    </div>

				    <!-- Used to display form errors. -->
				    <div id="card-errors" role="alert"></div>
				  </div>
				  
				  <div style="clear:left"></div>
                    <hr class="mb-4">
                    <button class="btn btn-primary btn-lg btn-block" type="submit">Continue to checkout</button>
                </form>

            </div>
        </div>
        <footer class="my-5 pt-5 text-muted text-center text-small">
            <p class="mb-1">© 2021 TBW by Urvi Dama</p>
            <ul class="list-inline">
                <li class="list-inline-item"><a href={% url "privacy" %}>Privacy</a></li>
                <li class="list-inline-item"><a href={% url "terms" %}>Terms</a></li>
                <li class="list-inline-item"><a href={% url "cancel" %}>Refund and shipping</a></li>

            </ul>
        </footer>
    </div>

    <script src="static/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
        integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
        integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
        crossorigin="anonymous"></script>


    <script type="text/javascript">
        var form = document.getElementById('form')

        form.addEventListener('submit', function (e) {
            e.preventDefault()
            console.log('Form Submitted...')
            document.getElementById('form-button').classList.add("hidden");
            document.getElementById('payment-info').classList.remove("hidden");
        })

        function submitFormData() {
            console.log('Payment button clicked')

            var userFormData = {
                'name': null,
                'email': null,
                'username': null,
                'total': total,
            }

            var shippingInfo = {
                'address': null,
                'city': null,
                'state': null,
                'zipcode': null,
            }

            shippingInfo.address = form.address.value
            shippingInfo.city = form.city.value
            shippingInfo.state = form.state.value
            shippingInfo.zipcode = form.zipcode.value

            userFormData.name = form.name.value
            userFormData.username = form.username.value
            userFormData.email = form.email.value

            console.log('Shipping Info:', shippingInfo)
            console.log('User Info:', userFormData)

            var url = "process_order"
            console.log(url)
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ 'form': userFormData, 'shipping': shippingInfo }),

            })
                .then((response) => response.json())
                .then((data) => {
                    console.log('Success:', data);
                    alert('Transaction completed');
                    window.location.href = "{% url 'shop' %}"
                })
        }
    </script>
    <script>
		// Create a Stripe client.
		var stripe = Stripe('pk_test_51IxRjHSIQHZ7i5SZwWSA5NSc7E1ZtZCcRPO69N4z1zQoKUCjz9xXfze2ifESyTbO0bFD4B8rRldJ0s5hYL54vN9L00tAnqxZph');

		// Create an instance of Elements.
		var elements = stripe.elements();

		// Custom styling can be passed to options when creating an Element.
		// (Note that this demo uses a wider set of styles than the guide below.)
		var style = {
		  base: {
		    color: '#32325d',
		    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
		    fontSmoothing: 'antialiased',
		    fontSize: '16px',
		    '::placeholder': {
		      color: '#aab7c4'
		    }
		  },
		  invalid: {
		    color: '#fa755a',
		    iconColor: '#fa755a'
		  }
		};

		// Create an instance of the card Element.
		var card = elements.create('card', {style: style});

		// Add an instance of the card Element into the `card-element` <div>.
		card.mount('#card-element');

		// Handle real-time validation errors from the card Element.
		card.addEventListener('change', function(event) {
		  var displayError = document.getElementById('card-errors');
		  if (event.error) {
		    displayError.textContent = event.error.message;
		  } else {
		    displayError.textContent = '';
		  }
		});

		// Handle form submission.
		var form = document.getElementById('payment-form');
		form.addEventListener('submit', function(event) {
		  event.preventDefault();

		  stripe.createToken(card).then(function(result) {
		    if (result.error) {
		      // Inform the user if there was an error.
		      var errorElement = document.getElementById('card-errors');
		      errorElement.textContent = result.error.message;
		    } else {
		      // Send the token to your server.
		      stripeTokenHandler(result.token);
		    }
		  });
		});

		// Submit the form with the token ID.
		function stripeTokenHandler(token) {
		  // Insert the token ID into the form so it gets submitted to the server
		  var form = document.getElementById('payment-form');
		  var hiddenInput = document.createElement('input');
		  hiddenInput.setAttribute('type', 'hidden');
		  hiddenInput.setAttribute('name', 'stripeToken');
		  hiddenInput.setAttribute('value', token.id);
		  form.appendChild(hiddenInput);

		  // Submit the form
		  form.submit();
		}
	</script>
</body>

</html>